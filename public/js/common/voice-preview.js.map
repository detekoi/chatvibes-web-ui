{
  "version": 3,
  "sources": ["voice-preview.ts"],
  "sourcesContent": ["import { getApiBaseUrl, fetchWithAuth } from './api.js';\nimport { showToast } from './ui.js';\n\n/**\n * TTS test payload\n */\nexport interface TTSPayload {\n  text: string;\n  voiceId?: string;\n  pitch?: number;\n  speed?: number;\n  emotion?: string;\n  languageBoost?: string;\n}\n\n/**\n * Player elements for audio playback\n */\nexport interface PlayerElements {\n  playerEl?: HTMLElement | null;\n  playerElMobile?: HTMLElement | null;\n  sourceEl?: HTMLSourceElement | null;\n  sourceElMobile?: HTMLSourceElement | null;\n}\n\n/**\n * Hint elements to hide when audio is ready\n */\nexport interface HintElements {\n  hintEl?: HTMLElement | null;\n  hintElMobile?: HTMLElement | null;\n}\n\n/**\n * Options for voice test\n */\nexport interface VoiceTestOptions {\n  defaultText?: string;\n  playerElements?: PlayerElements;\n  hintElements?: HintElements;\n  onAudioGenerated?: (audioUrl: string, payload: TTSPayload) => void;\n}\n\n/**\n * API response for TTS test\n */\ninterface TTSResponse {\n  audioUrl?: string;\n  audio_url?: string;\n  url?: string;\n  audio?: string;\n  audioBase64?: string;\n  output?: string | string[] | {\n    audio?: string;\n    audio_url?: string;\n    url?: string;\n  };\n  message?: string;\n  error?: string;\n}\n\n/**\n * Send a TTS preview request and play the resulting audio.\n * @returns The audio URL, if available.\n */\nexport async function performVoiceTest(\n  payload: TTSPayload,\n  buttons: (HTMLButtonElement | null)[] = [],\n  options: VoiceTestOptions = {}\n): Promise<string | undefined> {\n  const safeButtons = Array.isArray(buttons) ? buttons.filter((btn): btn is HTMLButtonElement => btn !== null) : [];\n\n  safeButtons.forEach(btn => {\n    btn.disabled = true;\n    btn.textContent = 'Generating...';\n  });\n\n  try {\n    let audioUrl: string | null = null;\n\n    if (options.defaultText && isDefaultSettings(payload, options.defaultText)) {\n      audioUrl = await tryLoadPreMadeRecording(payload, options.defaultText);\n      if (audioUrl) {\n        console.log('Using pre-made recording');\n      }\n    }\n\n    if (!audioUrl) {\n      const response = await fetchWithAuth(`${getApiBaseUrl()}/api/tts/test`, {\n        method: 'POST',\n        body: JSON.stringify(payload),\n      });\n\n      const contentType = response.headers.get('Content-Type') || '';\n      if (contentType.startsWith('audio/')) {\n        const blob = await response.blob();\n        audioUrl = URL.createObjectURL(blob);\n      } else {\n        const data = await response.json() as TTSResponse;\n        const candidateUrl = (\n          data.audioUrl || data.audio_url || data.url || data.audio ||\n          (Array.isArray(data.output) ? data.output[0] : (\n            typeof data.output === 'object' && data.output !== null ?\n              (data.output.audio || data.output.audio_url || data.output.url) :\n              data.output\n          ))\n        );\n\n        if (candidateUrl && typeof candidateUrl === 'string') {\n          audioUrl = candidateUrl;\n        } else if (data.audioBase64) {\n          const byteString = atob(data.audioBase64);\n          const arrayBuffer = new Uint8Array(byteString.length);\n          for (let i = 0; i < byteString.length; i++) {\n            arrayBuffer[i] = byteString.charCodeAt(i);\n          }\n          const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });\n          audioUrl = URL.createObjectURL(blob);\n        } else {\n          throw new Error(data.message || data.error || 'No audio returned by server');\n        }\n      }\n    }\n\n    if (options.playerElements) {\n      await handleAudioPlayer(audioUrl, options.playerElements, options.hintElements);\n    } else if (audioUrl) {\n      const audio = new Audio(audioUrl);\n      await audio.play();\n      audio.addEventListener('ended', () => {\n        if (audioUrl && audioUrl.startsWith('blob:')) {\n          URL.revokeObjectURL(audioUrl);\n        }\n      });\n    }\n\n    if (options.onAudioGenerated && audioUrl) {\n      options.onAudioGenerated(audioUrl, payload);\n    }\n\n    return audioUrl;\n  } catch (error) {\n    console.error('Voice test failed:', error);\n    const err = error as Error;\n    let errorMessage = err.message;\n    if (err.message && err.message.includes('API Error:')) {\n      const match = err.message.match(/API Error: \\d+ (.+)/);\n      if (match) {\n        errorMessage = match[1] || errorMessage;\n      }\n    }\n    showToast(`Test failed: ${errorMessage}`, 'error');\n  } finally {\n    safeButtons.forEach(btn => {\n      btn.disabled = false;\n      btn.textContent = 'Regenerate';\n    });\n  }\n}\n\nfunction isDefaultSettings(payload: TTSPayload, defaultText: string): boolean {\n  const isDefaultText = payload.text.trim().toLowerCase() === defaultText.toLowerCase();\n  const isDefault = (\n    (!payload.pitch || payload.pitch === 0) &&\n    (!payload.speed || payload.speed === 1.0) &&\n    (!payload.emotion || payload.emotion === 'auto' || payload.emotion === 'neutral') &&\n    (!payload.languageBoost || payload.languageBoost === 'Automatic' || payload.languageBoost === 'auto')\n  );\n  return isDefaultText && isDefault;\n}\n\nasync function tryLoadPreMadeRecording(payload: TTSPayload, defaultText: string): Promise<string | null> {\n  const voiceId = payload.voiceId || 'Friendly_Person';\n  const fileName = defaultText.toLowerCase()\n    .replace(/[^a-z0-9]/g, '-')\n    .replace(/-+/g, '-')\n    .replace(/^-|-$/g, '');\n  const preMadeUrl = `/assets/voices/${voiceId}-${fileName}.mp3`;\n\n  try {\n    const response = await fetch(preMadeUrl);\n    if (response.ok) {\n      const blob = await response.blob();\n      return URL.createObjectURL(blob);\n    }\n  } catch (error) {\n    console.log('No pre-made recording available for', voiceId, 'with text:', defaultText);\n  }\n\n  return null;\n}\n\n// Track blob URLs for each audio element to properly clean them up\n// Use WeakMap to avoid memory leaks when elements are removed\nconst audioBlobUrls = new WeakMap<HTMLAudioElement, string>();\n\nasync function handleAudioPlayer(\n  audioUrl: string | null,\n  playerElements: PlayerElements,\n  hintElements?: HintElements\n): Promise<void> {\n  if (!audioUrl) return;\n\n  const { playerEl, playerElMobile, sourceEl, sourceElMobile } = playerElements;\n  const { hintEl, hintElMobile } = hintElements || {};\n\n  if (sourceEl && playerEl) {\n    const audioElement = playerEl.querySelector('audio');\n    if (audioElement) {\n      // Revoke previous blob URL if it exists (Safari fix)\n      const previousUrl = audioBlobUrls.get(audioElement);\n      if (previousUrl && previousUrl.startsWith('blob:')) {\n        URL.revokeObjectURL(previousUrl);\n      }\n\n      // Store new blob URL for future cleanup\n      if (audioUrl.startsWith('blob:')) {\n        audioBlobUrls.set(audioElement, audioUrl);\n      }\n\n      sourceEl.src = audioUrl;\n      audioElement.load();\n      try {\n        await audioElement.play();\n      } catch (err) {\n        console.error('Error playing audio:', err);\n        showToast('Error playing audio sample', 'error');\n      }\n    }\n    playerEl.style.display = 'block';\n    if (hintEl) hintEl.style.display = 'none';\n  }\n\n  if (sourceElMobile && playerElMobile) {\n    const audioElementMobile = playerElMobile.querySelector('audio');\n    if (audioElementMobile) {\n      // Revoke previous blob URL if it exists (Safari fix)\n      const previousUrl = audioBlobUrls.get(audioElementMobile);\n      if (previousUrl && previousUrl.startsWith('blob:')) {\n        URL.revokeObjectURL(previousUrl);\n      }\n\n      // Store new blob URL for future cleanup\n      if (audioUrl.startsWith('blob:')) {\n        audioBlobUrls.set(audioElementMobile, audioUrl);\n      }\n\n      sourceElMobile.src = audioUrl;\n      audioElementMobile.load();\n    }\n    playerElMobile.style.display = 'block';\n    if (hintElMobile) hintElMobile.style.display = 'none';\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
