{
  "version": 3,
  "sources": ["bot-management.ts"],
  "sourcesContent": ["import { fetchWithAuth } from '../common/api.js';\nimport { showToast } from '../common/ui.js';\n\n/**\n * Bot management module parameters\n */\ninterface BotManagementElements {\n  botStatusEl: HTMLElement | null;\n  oauthTierStatusEl: HTMLElement | null;\n  addBotBtn: HTMLButtonElement | null;\n  removeBotBtn: HTMLButtonElement | null;\n  switchModeBtn: HTMLButtonElement | null;\n}\n\n/**\n * Bot management context\n */\ninterface BotManagementContext {\n  apiBaseUrl: string;\n  testMode: boolean;\n}\n\n/**\n * Bot management services\n */\ninterface BotManagementServices {\n  getSessionToken: () => string | null;\n}\n\n/**\n * Bot status API response\n */\ninterface BotStatusResponse {\n  success: boolean;\n  isActive: boolean;\n  oauthTier?: 'anonymous' | 'full';\n  message?: string;\n}\n\n/**\n * Bot add/remove API response\n */\ninterface BotActionResponse {\n  success: boolean;\n  message?: string;\n  code?: string;\n  details?: string;\n}\n\n/**\n * Auth initiate API response\n */\ninterface AuthInitiateResponse {\n  success: boolean;\n  twitchAuthUrl?: string;\n  state?: string;\n  tier?: string;\n  error?: string;\n}\n\n/**\n * Bot management module return type\n */\nexport interface BotManagementModule {\n  refreshStatus: () => Promise<void>;\n  updateBotStatusUI: (isActive: boolean) => void;\n}\n\n/**\n * Bot management card bindings.\n */\nexport function initBotManagement(\n  { botStatusEl, oauthTierStatusEl, addBotBtn, removeBotBtn, switchModeBtn }: BotManagementElements,\n  context: BotManagementContext,\n  services: BotManagementServices\n): BotManagementModule {\n  const { apiBaseUrl, testMode } = context;\n  const { getSessionToken } = services;\n\n  let currentTier: 'anonymous' | 'full' | null = null;\n  let currentIsActive: boolean = false;\n\n  function updateOAuthTierUI(tier: 'anonymous' | 'full' | null, isActive: boolean): void {\n    currentTier = tier;\n    currentIsActive = isActive;\n    if (oauthTierStatusEl) {\n      if (tier === 'anonymous') {\n        // Bot-Free Mode: bot is not in chat, regardless of active status\n        oauthTierStatusEl.textContent = '\uD83C\uDFA4 Bot-Free Mode';\n        oauthTierStatusEl.className = 'fw-semibold text-primary';\n      } else if (tier === 'full') {\n        // Chatbot Mode: show active/inactive status\n        if (isActive) {\n          oauthTierStatusEl.textContent = '\uD83E\uDD16 Chatbot Mode (Active)';\n          oauthTierStatusEl.className = 'fw-semibold text-success';\n        } else {\n          oauthTierStatusEl.textContent = '\uD83E\uDD16 Chatbot Mode (Inactive)';\n          oauthTierStatusEl.className = 'fw-semibold text-secondary';\n        }\n      } else {\n        oauthTierStatusEl.textContent = 'Unknown';\n        oauthTierStatusEl.className = 'fw-semibold text-muted';\n      }\n    }\n    if (switchModeBtn && tier) {\n      switchModeBtn.style.display = 'inline-block';\n      switchModeBtn.textContent = tier === 'anonymous' ? 'Switch to Chatbot Mode' : 'Switch to Bot-Free Mode';\n    }\n  }\n\n  function updateBotStatusUI(isActive: boolean): void {\n    if (isActive) {\n      if (botStatusEl) {\n        botStatusEl.textContent = 'Active';\n        botStatusEl.className = 'fw-semibold text-success';\n      }\n      if (addBotBtn) addBotBtn.style.display = 'none';\n      if (removeBotBtn) removeBotBtn.style.display = 'inline-block';\n    } else {\n      if (botStatusEl) {\n        botStatusEl.textContent = 'Inactive';\n        botStatusEl.className = 'fw-semibold text-secondary';\n      }\n      if (addBotBtn) addBotBtn.style.display = 'inline-block';\n      if (removeBotBtn) removeBotBtn.style.display = 'none';\n    }\n  }\n\n  async function refreshStatus(): Promise<void> {\n    if (testMode) {\n      updateBotStatusUI(false);\n      updateOAuthTierUI('anonymous', false);\n      return;\n    }\n\n    if (!getSessionToken()) {\n      if (botStatusEl) botStatusEl.textContent = 'Not authenticated';\n      return;\n    }\n\n    try {\n      const statusRes = await fetchWithAuth(`${apiBaseUrl}/api/bot/status`, { method: 'GET' });\n      const statusData = await statusRes.json() as BotStatusResponse;\n      if (statusData.success) {\n        const isActive = statusData.isActive;\n        const tier = statusData.oauthTier || 'full'; // Default to 'full' for backward compatibility\n        updateBotStatusUI(isActive);\n        updateOAuthTierUI(tier, isActive);\n      } else {\n        showToast(`Error: ${statusData.message}`, 'error');\n        if (botStatusEl) botStatusEl.textContent = 'Error';\n      }\n    } catch (error) {\n      console.error('Error fetching bot status:', error);\n      const err = error as Error;\n      showToast(`Failed to load bot status. ${err.message}`, 'error');\n      if (botStatusEl) botStatusEl.textContent = 'Error';\n    }\n  }\n\n  if (addBotBtn) {\n    addBotBtn.addEventListener('click', async () => {\n      if (testMode) {\n        showToast('TTS Service activated! (test mode)', 'success');\n        updateBotStatusUI(true);\n        return;\n      }\n      if (!getSessionToken()) {\n        showToast('Authentication token missing. Please log in again.', 'error');\n        return;\n      }\n      showToast('Activating TTS Service...', 'info');\n      try {\n        const res = await fetchWithAuth(`${apiBaseUrl}/api/bot/add`, { method: 'POST' });\n        const data = await res.json() as BotActionResponse;\n        if (data.success) {\n          showToast(data.message || 'TTS Service activated!', 'success');\n          updateBotStatusUI(true);\n        } else if (data.code === 'not_allowed') {\n          const errorText = data.details || data.message || 'Channel not authorized.';\n          const html = errorText.includes('https://detekoi.github.io/#contact-me')\n            ? errorText.replace('https://detekoi.github.io/#contact-me', '<a href=\"https://detekoi.github.io/#contact-me\" target=\"_blank\" class=\"link-light\">this link</a>')\n            : `${errorText} <a href=\"https://detekoi.github.io/#contact-me\" target=\"_blank\" class=\"link-light\">Request access here</a>.`;\n          showToast(html, 'error');\n        } else {\n          showToast(data.message || 'Failed to activate TTS Service.', 'error');\n        }\n      } catch (error) {\n        console.error('Error activating TTS Service:', error);\n        showToast('Failed to activate TTS Service.', 'error');\n      }\n    });\n  }\n\n  if (removeBotBtn) {\n    removeBotBtn.addEventListener('click', async () => {\n      if (testMode) {\n        showToast('TTS Service deactivated. (test mode)', 'success');\n        updateBotStatusUI(false);\n        return;\n      }\n      if (!getSessionToken()) {\n        showToast('Authentication token missing. Please log in again.', 'error');\n        return;\n      }\n      showToast('Deactivating TTS Service...', 'info');\n      try {\n        const res = await fetchWithAuth(`${apiBaseUrl}/api/bot/remove`, { method: 'POST' });\n        const data = await res.json() as BotActionResponse;\n        showToast(data.message || 'TTS Service deactivated.', data.success ? 'success' : 'error');\n        if (data.success) updateBotStatusUI(false);\n      } catch (error) {\n        console.error('Error deactivating TTS Service:', error);\n        showToast('Failed to deactivate TTS Service.', 'error');\n      }\n    });\n  }\n\n  if (switchModeBtn) {\n    switchModeBtn.addEventListener('click', async () => {\n      const targetTier = currentTier === 'anonymous' ? 'full' : 'anonymous';\n      const targetModeName = targetTier === 'anonymous' ? 'Bot-Free Mode' : 'Chatbot Mode';\n\n      if (targetTier === 'full') {\n        // Upgrading to full mode requires re-authentication with more scopes\n        if (confirm(`Switching to Chatbot Mode requires re-authenticating with additional permissions. You'll be redirected to Twitch. Continue?`)) {\n          try {\n            showToast('Redirecting to Twitch for authentication...', 'info');\n            const response = await fetch(`${apiBaseUrl}/auth/twitch/initiate?tier=full`);\n            if (!response.ok) {\n              throw new Error(`Failed to initiate auth: ${response.statusText}`);\n            }\n            const data = await response.json() as AuthInitiateResponse;\n            if (data.success && data.twitchAuthUrl && data.state) {\n              sessionStorage.setItem('oauth_csrf_state', data.state);\n              window.location.href = data.twitchAuthUrl;\n            } else {\n              throw new Error(data.error || 'Could not initiate login with Twitch');\n            }\n          } catch (error) {\n            console.error('Error during login initiation:', error);\n            const err = error as Error;\n            showToast(`Failed to start authentication: ${err.message}`, 'error');\n          }\n        }\n      } else {\n        // Downgrading to anonymous mode just updates preference (no re-auth needed)\n        if (confirm(`Switch to ${targetModeName}? This will update your authentication preference.`)) {\n          try {\n            const res = await fetchWithAuth(`${apiBaseUrl}/api/auth/update-tier`, {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({ tier: targetTier }),\n            });\n            const data = await res.json() as BotActionResponse;\n            if (data.success) {\n              showToast(`Switched to ${targetModeName}!`, 'success');\n              // Refresh status to get updated tier and active status\n              await refreshStatus();\n            } else {\n              showToast(data.message || 'Failed to switch mode.', 'error');\n            }\n          } catch (error) {\n            console.error('Error switching mode:', error);\n            showToast('Failed to switch mode.', 'error');\n          }\n        }\n      }\n    });\n  }\n\n  return { refreshStatus, updateBotStatusUI };\n}\n"],
  "mappings": "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",
  "names": []
}
