{
  "version": 3,
  "sources": ["obs.ts"],
  "sourcesContent": ["import { fetchWithAuth } from '../common/api.js';\nimport { copyToClipboard, showToast } from '../common/ui.js';\n\n/**\n * OBS module elements\n */\ninterface ObsElements {\n  ttsUrlField: HTMLInputElement | null;\n  copyTtsUrlBtn: HTMLButtonElement | null;\n  regenerateTtsUrlBtn: (HTMLAnchorElement | HTMLButtonElement) | null;\n}\n\n/**\n * OBS module context\n */\ninterface ObsContext {\n  apiBaseUrl: string;\n  testMode: boolean;\n}\n\n/**\n * OBS module services\n */\ninterface ObsServices {\n  getLoggedInUser: () => { login: string; id: string; displayName: string } | null;\n}\n\n/**\n * OBS token API response\n */\ninterface ObsTokenResponse {\n  success: boolean;\n  browserSourceUrl?: string;\n  message?: string;\n}\n\n/**\n * OBS module return type\n */\nexport interface ObsModule {\n  loadExistingTtsUrl: (login: string) => Promise<void>;\n  updateTtsUrl: (login: string) => Promise<void>;\n}\n\n/**\n * OBS setup helpers (browser source URL management).\n */\nexport function initObsModule(\n  { ttsUrlField, copyTtsUrlBtn, regenerateTtsUrlBtn }: ObsElements,\n  context: ObsContext,\n  services: ObsServices\n): ObsModule {\n  const { apiBaseUrl, testMode } = context;\n  const { getLoggedInUser } = services;\n\n  async function loadExistingTtsUrl(userLoginName: string): Promise<void> {\n    if (!ttsUrlField) return;\n    if (testMode) {\n      ttsUrlField.value = `https://example.com/tts/test?channel=${encodeURIComponent(userLoginName || 'demo')}`;\n      ttsUrlField.placeholder = 'Test mode URL';\n      return;\n    }\n    if (!userLoginName || userLoginName.trim() === '' || userLoginName === 'loading...') {\n      ttsUrlField.value = '';\n      ttsUrlField.placeholder = 'Could not determine TTS URL.';\n      return;\n    }\n    ttsUrlField.value = 'Loading existing URL...';\n    ttsUrlField.placeholder = '';\n    try {\n      const response = await fetchWithAuth(`${apiBaseUrl}/api/obs/getToken`, { method: 'GET' });\n      const data = await response.json() as ObsTokenResponse;\n      if (data.success && data.browserSourceUrl) {\n        ttsUrlField.value = data.browserSourceUrl;\n        ttsUrlField.placeholder = 'Your existing OBS Browser Source URL';\n        console.log('Dashboard: Loaded existing OBS URL for', userLoginName);\n      } else {\n        ttsUrlField.value = '';\n        ttsUrlField.placeholder = 'Click \"Regenerate URL\" to generate your OBS Browser Source URL';\n      }\n    } catch (error) {\n      console.error('Dashboard: Error loading existing TTS URL:', error);\n      ttsUrlField.value = '';\n      ttsUrlField.placeholder = 'Click \"Regenerate URL\" to generate your OBS Browser Source URL';\n    }\n  }\n\n  async function updateTtsUrl(userLoginName: string): Promise<void> {\n    if (!ttsUrlField) return;\n    if (testMode) {\n      ttsUrlField.value = `https://example.com/tts/new-test-url?channel=${encodeURIComponent(userLoginName || 'demo')}`;\n      ttsUrlField.placeholder = 'Test mode URL';\n      showToast('Generated a new URL successfully. (test mode)', 'success');\n      return;\n    }\n    if (!userLoginName || userLoginName.trim() === '' || userLoginName === 'loading...') {\n      ttsUrlField.value = '';\n      ttsUrlField.placeholder = 'Could not determine TTS URL.';\n      return;\n    }\n    ttsUrlField.value = 'Generating secure URL...';\n    ttsUrlField.placeholder = '';\n    try {\n      const response = await fetchWithAuth(`${apiBaseUrl}/api/obs/generateToken`, { method: 'POST' });\n      const data = await response.json() as ObsTokenResponse;\n      if (data.success && data.browserSourceUrl) {\n        ttsUrlField.value = data.browserSourceUrl;\n        ttsUrlField.placeholder = 'Your secure OBS Browser Source URL';\n        showToast('Generated a new URL successfully.', 'success');\n      } else {\n        throw new Error(data.message || 'Failed to generate OBS URL');\n      }\n    } catch (error) {\n      console.error('Dashboard: Error generating OBS URL:', error);\n      ttsUrlField.value = '';\n      ttsUrlField.placeholder = 'Error generating URL. Please try refreshing.';\n      showToast('Failed to generate OBS URL. Please try again.', 'error');\n    }\n  }\n\n  if (copyTtsUrlBtn && ttsUrlField) {\n    copyTtsUrlBtn.addEventListener('click', async () => {\n      if (!ttsUrlField.value) {\n        showToast('URL not available yet.', 'warning');\n        return;\n      }\n      ttsUrlField.select();\n      ttsUrlField.setSelectionRange(0, 99999);\n      try {\n        const success = await copyToClipboard(ttsUrlField.value);\n        if (success) {\n          showToast('Copied to clipboard!', 'success');\n          const original = copyTtsUrlBtn.textContent;\n          copyTtsUrlBtn.textContent = 'Copied!';\n          setTimeout(() => { copyTtsUrlBtn.textContent = original; }, 2000);\n        } else {\n          showToast('Copy failed.', 'error');\n        }\n      } catch (err) {\n        console.error('Copy attempt error:', err);\n        showToast('Failed to copy.', 'error');\n      }\n    });\n  }\n\n  if (regenerateTtsUrlBtn) {\n    regenerateTtsUrlBtn.addEventListener('click', async (e: Event) => {\n      e.preventDefault();\n      const userLogin = getLoggedInUser()?.login;\n      if (testMode) {\n        const originalText = regenerateTtsUrlBtn.textContent;\n        regenerateTtsUrlBtn.textContent = 'Generating...';\n        regenerateTtsUrlBtn.style.pointerEvents = 'none';\n        await new Promise(r => setTimeout(r, 500));\n        await updateTtsUrl(userLogin || 'demo');\n        regenerateTtsUrlBtn.style.pointerEvents = 'auto';\n        regenerateTtsUrlBtn.textContent = originalText;\n        return;\n      }\n      if (!userLogin) {\n        showToast('Error: User not logged in.', 'error');\n        return;\n      }\n      const originalText = regenerateTtsUrlBtn.textContent;\n      regenerateTtsUrlBtn.textContent = 'Generating...';\n      regenerateTtsUrlBtn.style.pointerEvents = 'none';\n      try {\n        await updateTtsUrl(userLogin);\n      } finally {\n        regenerateTtsUrlBtn.style.pointerEvents = 'auto';\n        regenerateTtsUrlBtn.textContent = originalText;\n      }\n    });\n  }\n\n  return { loadExistingTtsUrl, updateTtsUrl };\n}\n"],
  "mappings": "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",
  "names": ["originalText"]
}
