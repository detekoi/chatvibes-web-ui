{
  "version": 3,
  "sources": ["danger-zone.ts"],
  "sourcesContent": ["import { fetchWithAuth } from '../common/api.js';\nimport { showToast, openDialog, closeDialog } from '../common/ui.js';\n\n/**\n * Context object passed to the danger zone module.\n */\nexport interface DangerZoneContext {\n  apiBaseUrl: string;\n  testMode: boolean;\n}\n\n/**\n * Services provided to the danger zone module.\n */\nexport interface DangerZoneServices {\n  getCurrentChannel: () => string | null;\n}\n\n/**\n * Options for requesting a channel from the user.\n */\nexport interface RequestChannelOptions {\n  title: string;\n  description: string;\n  confirmLabel: string;\n  confirmClass: string;\n  onConfirm: (channelName: string) => void;\n}\n\n/**\n * Dependencies that can be injected into the module.\n */\nexport interface DangerZoneDeps {\n  requestChannel?: (options: RequestChannelOptions) => void;\n}\n\n/**\n * Status of whether a user is ignored for TTS/music.\n */\nexport interface IgnoreStatus {\n  tts?: boolean;\n  music?: boolean;\n}\n\n/**\n * DOM elements used by the danger zone module.\n */\ninterface DangerZoneElements {\n  dangerZoneSection: HTMLElement | null;\n  dangerTtsToggle: HTMLElement | null;\n  dangerMusicToggle: HTMLElement | null;\n  ignoreTtsCheckbox: HTMLInputElement | null;\n  ignoreMusicCheckbox: HTMLInputElement | null;\n  confirmModal: HTMLDialogElement | null;\n  confirmText: HTMLElement | null;\n  confirmYes: HTMLButtonElement | null;\n  confirmNo: HTMLButtonElement | null;\n}\n\n/**\n * Pending action state.\n */\ninterface PendingAction {\n  type: 'tts' | 'music';\n  checkbox: HTMLInputElement;\n}\n\n/**\n * Return type of the danger zone module.\n */\nexport interface DangerZoneModule {\n  updateChannel(channelName: string, ignoreStatus?: IgnoreStatus): void;\n  clear(): void;\n}\n\n/**\n * Handles viewer opt-out toggles for TTS and music.\n */\nexport function initDangerZoneModule(\n  context: DangerZoneContext,\n  services: DangerZoneServices,\n  deps: DangerZoneDeps = {}\n): DangerZoneModule {\n  const { apiBaseUrl, testMode } = context;\n  const { getCurrentChannel } = services;\n  const { requestChannel } = deps;\n\n  const elements: DangerZoneElements = {\n    dangerZoneSection: document.getElementById('danger-zone-section'),\n    dangerTtsToggle: document.getElementById('danger-tts-toggle'),\n    dangerMusicToggle: document.getElementById('danger-music-toggle'),\n    ignoreTtsCheckbox: document.getElementById('ignore-tts') as HTMLInputElement | null,\n    ignoreMusicCheckbox: document.getElementById('ignore-music') as HTMLInputElement | null,\n    confirmModal: document.getElementById('confirm-modal') as HTMLDialogElement | null,\n    confirmText: document.getElementById('confirm-text'),\n    confirmYes: document.getElementById('confirm-yes') as HTMLButtonElement | null,\n    confirmNo: document.getElementById('confirm-no') as HTMLButtonElement | null,\n  };\n\n  let pendingAction: PendingAction | null = null;\n  let pendingChannel: string | null = null;\n\n  attachListeners();\n\n  return {\n    updateChannel(channelName: string, ignoreStatus: IgnoreStatus = {}): void {\n      const hasChannel = Boolean(channelName);\n      toggleVisibility(hasChannel);\n      updateIgnoreCheckboxes(ignoreStatus);\n    },\n    clear(): void {\n      toggleVisibility(false);\n      updateIgnoreCheckboxes({});\n    },\n  };\n\n  function attachListeners(): void {\n    if (elements.ignoreTtsCheckbox) {\n      elements.ignoreTtsCheckbox.addEventListener('change', () => {\n        if (elements.ignoreTtsCheckbox?.checked) handleIgnoreAction('tts');\n      });\n    }\n    if (elements.ignoreMusicCheckbox) {\n      elements.ignoreMusicCheckbox.addEventListener('change', () => {\n        if (elements.ignoreMusicCheckbox?.checked) handleIgnoreAction('music');\n      });\n    }\n    if (elements.confirmYes) {\n      elements.confirmYes.addEventListener('click', confirmIgnoreAction);\n    }\n    if (elements.confirmNo) {\n      elements.confirmNo.addEventListener('click', cancelIgnoreAction);\n    }\n  }\n\n  function toggleVisibility(visible: boolean): void {\n    if (elements.dangerZoneSection) {\n      elements.dangerZoneSection.classList.toggle('d-none', !visible);\n    }\n    if (elements.dangerTtsToggle) {\n      elements.dangerTtsToggle.style.display = visible ? '' : 'none';\n    }\n    if (elements.dangerMusicToggle) {\n      elements.dangerMusicToggle.style.display = visible ? '' : 'none';\n    }\n  }\n\n  function updateIgnoreCheckboxes(ignoreStatus: IgnoreStatus): void {\n    const { ignoreTtsCheckbox, ignoreMusicCheckbox } = elements;\n    if (ignoreTtsCheckbox) {\n      const disabled = ignoreStatus.tts === true;\n      ignoreTtsCheckbox.checked = disabled;\n      ignoreTtsCheckbox.disabled = disabled;\n    }\n    if (ignoreMusicCheckbox) {\n      const disabled = ignoreStatus.music === true;\n      ignoreMusicCheckbox.checked = disabled;\n      ignoreMusicCheckbox.disabled = disabled;\n    }\n  }\n\n  function handleIgnoreAction(type: 'tts' | 'music'): void {\n    const checkbox = type === 'tts' ? elements.ignoreTtsCheckbox : elements.ignoreMusicCheckbox;\n    if (!checkbox) return;\n\n    if (testMode) {\n      checkbox.disabled = true;\n      showToast(`You have been opted out of ${type.toUpperCase()} (test mode)`, 'success');\n      return;\n    }\n\n    const currentChannel = getCurrentChannel();\n    if (currentChannel) {\n      pendingAction = { type, checkbox };\n      pendingChannel = currentChannel;\n      showConfirmModal(type, currentChannel);\n    } else if (typeof requestChannel === 'function') {\n      requestChannel({\n        title: `Confirm channel for ${type.toUpperCase()} opt-out`,\n        description: 'Enter the channel name to continue:',\n        confirmLabel: 'Continue',\n        confirmClass: 'btn-danger',\n        onConfirm: (channelName: string) => {\n          pendingAction = { type, checkbox };\n          pendingChannel = channelName;\n          showConfirmModal(type, channelName);\n        },\n      });\n    } else {\n      showToast('Please select a channel first.', 'warning');\n      checkbox.checked = false;\n    }\n  }\n\n  function showConfirmModal(type: 'tts' | 'music', channelName: string): void {\n    if (!elements.confirmModal) return;\n    if (elements.confirmText) {\n      elements.confirmText.textContent = `Are you absolutely sure you want to opt out of ${type.toUpperCase()} in #${channelName}? Only a moderator can undo this action.`;\n    }\n    openDialog(elements.confirmModal);\n  }\n\n  async function confirmIgnoreAction(): Promise<void> {\n    if (!pendingAction) return;\n    const { type, checkbox } = pendingAction;\n    try {\n      if (testMode) {\n        checkbox.disabled = true;\n        showToast(`You have been opted out of ${type.toUpperCase()} (test mode)`, 'success');\n        closeDialog(elements.confirmModal);\n        pendingAction = null;\n        pendingChannel = null;\n        return;\n      }\n      const targetChannel = pendingChannel || getCurrentChannel();\n      if (!targetChannel) {\n        showToast('Please specify a channel', 'error');\n        checkbox.checked = false;\n        closeDialog(elements.confirmModal);\n        pendingAction = null;\n        pendingChannel = null;\n        return;\n      }\n      await fetchWithAuth(`${apiBaseUrl}/api/viewer/ignore/${type}/${encodeURIComponent(targetChannel)}`, { method: 'POST' });\n      checkbox.disabled = true;\n      showToast(`You have been opted out of ${type.toUpperCase()}`, 'success');\n    } catch (error) {\n      console.error(`Failed to opt out of ${type}:`, error);\n      checkbox.checked = false;\n      showToast(`Failed to opt out of ${type.toUpperCase()}`, 'error');\n    }\n    closeDialog(elements.confirmModal);\n    pendingAction = null;\n    pendingChannel = null;\n  }\n\n  function cancelIgnoreAction(): void {\n    if (pendingAction?.checkbox) {\n      pendingAction.checkbox.checked = false;\n    }\n    pendingAction = null;\n    pendingChannel = null;\n    if (elements.confirmModal) closeDialog(elements.confirmModal);\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
